<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>UK Map with Connected Floating Callouts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    /* Floating callouts */
    .floating-callout {
      position: absolute;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      max-width: 320px;
      font-size: 13px;
      border-left: 4px solid #3b82f6;
      z-index: 1000;
      cursor: move;
      opacity: 0;
      transform: translateY(30px) scale(0.7) rotate(5deg);
      animation-fill-mode: both;
    }

    .edit-hint {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .floating-callout:hover .edit-hint {
      opacity: 1;
    }

    .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
      user-select: none;
    }

    .template-btn {
      position: absolute;
      top: -8px;
      right: 15px;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
      font-weight: bold;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
      user-select: none;
    }

    .floating-callout:hover .delete-btn,
    .floating-callout:hover .template-btn {
      opacity: 1;
      transform: scale(1.1);
    }

    .template-btn:hover {
      background: #2563eb;
      transform: scale(1.2) rotate(180deg);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.2) rotate(90deg);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
    }

    .delete-btn:active {
      transform: scale(0.9);
    }

    .floating-callout.show {
      animation: lottiePopup 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    .floating-callout.active {
      opacity: 0.95;
      animation: gentleFloat 4s ease-in-out infinite;
    }

    @keyframes lottiePopup {
      0% {
        opacity: 0;
        transform: translateY(30px) scale(0.7) rotate(5deg);
      }
      50% {
        opacity: 0.8;
        transform: translateY(-10px) scale(1.1) rotate(-2deg);
      }
      70% {
        opacity: 1;
        transform: translateY(5px) scale(0.95) rotate(1deg);
      }
      100% {
        opacity: 0.95;
        transform: translateY(0px) scale(1) rotate(0deg);
      }
    }

    @keyframes gentleFloat {
      0%, 100% { transform: translateY(0px) scale(1) rotate(0deg); }
      50% { transform: translateY(-8px) scale(1) rotate(0deg); }
    }

    .floating-callout:hover {
      opacity: 1;
      transform: scale(1.02);
      z-index: 1001;
      animation-play-state: paused;
    }

    /* Editable elements */
    .editable-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #1f2937;
      font-size: 14px;
      border: 1px solid transparent;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: text;
      min-height: 18px;
    }

    .editable-title:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .editable-title:focus {
      outline: none;
      background: #f9fafb;
      border-color: #3b82f6;
    }

    .thumbs-selector {
      margin-bottom: 8px;
      display: flex;
      gap: 3px;
    }

    .thumb {
      font-size: 20px;
      cursor: pointer;
      color: #d1d5db;
      transition: all 0.3s ease;
      padding: 3px;
      user-select: none;
      display: inline-block;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
      transform: scale(1);
    }

    .thumb.active {
      color: #fbbf24;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
      animation: thumbBounce 0.4s ease-out;
    }

    .thumb:hover {
      color: #f59e0b;
      transform: scale(1.3);
      text-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
    }

    @keyframes thumbBounce {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.4) rotate(-15deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .editable-body {
      border: 1px solid transparent;
      padding: 4px;
      border-radius: 3px;
      cursor: text;
      min-height: 40px;
      line-height: 1.4;
    }

    .editable-body:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .editable-body:focus {
      outline: none;
      background: #f9fafb;
      border-color: #3b82f6;
    }

    /* Template Styles */

    /* 1. Quotes Template */
    .template-quotes {
      background: white;
      color: #1f2937;
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
      font-family: 'Georgia', serif;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);
    }

    .template-quotes .editable-title {
      font-size: 15px;
      font-style: italic;
      font-weight: 500;
      color: #1f2937;
      line-height: 1.3;
    }

    .template-quotes .thumbs-selector {
      display: flex;
    }

    .quote-author {
      font-weight: 700;
      margin-top: 8px;
      color: #f59e0b;
      font-size: 13px;
    }

    .quote-role {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .quote-location {
      font-size: 11px;
      color: #9ca3af;
    }

    /* 2. Statistics Template */
    .template-statistics {
      background: white;
      color: #1f2937;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      text-align: center;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .template-statistics .editable-title {
      font-size: 42px;
      font-weight: 900;
      color: #3b82f6;
      margin-bottom: 4px;
    }

    .template-statistics .thumbs-selector {
      display: none;
    }

    .stat-description {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .stat-source {
      font-size: 10px;
      color: #9ca3af;
      font-style: italic;
    }

    /* 3. Charts Template */
    .template-charts {
      background: white;
      color: #1f2937;
      border-radius: 10px;
      border-left: 4px solid #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
      min-width: 280px;
      padding: 18px;
    }

    .template-charts .editable-title {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 15px;
      text-align: center;
    }

    .template-charts .thumbs-selector {
      display: none;
    }

    .template-charts .editable-body {
      pointer-events: none;
      user-select: none;
      cursor: default;
    }

    .template-charts .editable-body * {
      pointer-events: none;
      user-select: none;
    }

    .template-charts .chart-value {
      pointer-events: auto;
      user-select: auto;
      cursor: text;
    }

    .template-charts .chart-btn {
      pointer-events: auto;
      user-select: none;
      cursor: pointer;
    }

    .template-charts .chart-type-toggle {
      pointer-events: auto;
    }

    .chart-source {
      margin-top: 8px;
      text-align: center;
    }

    .chart-source-input {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 3px;
      padding: 4px 6px;
      font-size: 10px;
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      width: 100%;
      outline: none;
      box-sizing: border-box;
      cursor: text;
    }

    .chart-source-input:hover {
      border-color: #d1d5db;
      background: #f9fafb;
      cursor: text;
    }

    .chart-source-input:focus {
      border-color: #10b981;
      background: #f9fafb;
      color: #6b7280;
      cursor: text;
    }

    .template-charts .chart-source-input {
      pointer-events: auto !important;
      user-select: auto !important;
      cursor: text !important;
    }

    .template-charts .chart-source {
      pointer-events: auto !important;
    }

    .chart-placeholder {
      margin: 0;
      padding: 0;
      background: transparent;
      border: none;
      text-align: center;
    }

    .chart-type-toggle {
      display: none;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .template-charts:hover .chart-type-toggle {
      display: flex;
      opacity: 1;
    }

    .chart-btn {
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .chart-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .mini-bar-chart {
      display: flex;
      align-items: end;
      gap: 8px;
      height: 80px;
      margin-bottom: 12px;
      justify-content: center;
      background: #f8fafc;
      border-radius: 6px;
      padding: 10px;
      user-select: none;
    }

    .mini-bar-chart .bar {
      width: 24px;
      background: #10b981;
      border-radius: 3px 3px 0 0;
      min-height: 8px;
      transition: all 0.3s ease;
      cursor: default;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      display: flex;
      align-items: end;
      justify-content: center;
      pointer-events: none;
    }

    .bar-value {
      position: absolute;
      top: -18px;
      font-size: 10px;
      font-weight: 600;
      color: #374151;
      background: white;
      padding: 1px 4px;
      border-radius: 2px;
      border: 1px solid #e5e7eb;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
    }

    .mini-pie-chart {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: conic-gradient(#10b981 0deg 108deg, #3b82f6 108deg 216deg, #f59e0b 216deg 360deg);
      margin: 0 auto 12px;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      display: none;
      position: relative;
      user-select: none;
    }

    .pie-value {
      position: absolute;
      font-size: 9px;
      font-weight: 600;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      pointer-events: none;
      user-select: none;
    }

    .chart-values {
      display: none;
      gap: 12px;
      font-size: 12px;
      justify-content: center;
      margin-bottom: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .template-charts:hover .chart-values {
      display: flex;
      opacity: 1;
    }

    .chart-value {
      padding: 4px 8px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      min-width: 30px;
      width: 40px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      font-weight: 600;
      outline: none;
      font-size: 12px;
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .chart-value::-webkit-outer-spin-button,
    .chart-value::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .chart-value:hover {
      border-color: #10b981;
    }

    .chart-value:focus {
      border-color: #10b981;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    .chart-description {
      font-size: 11px;
      color: #6b7280;
      font-weight: 500;
      text-align: center;
      margin-top: 8px;
    }

    /* 4. Social Media Template */
    .template-social {
      background: white;
      color: #1f2937;
      border-radius: 12px;
      border-left: 4px solid #8b5cf6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }

    .template-social .editable-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 6px;
    }

    .template-social .thumbs-selector {
      display: none;
    }

    .social-platform {
      display: inline-block;
      background: #8b5cf6;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .social-text {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .social-engagement {
      font-size: 10px;
      color: #6b7280;
      display: flex;
      gap: 8px;
    }

    /* Template-specific badges */
    .badge-quotes {
      background: #f59e0b;
      color: white;
    }

    .badge-statistics {
      background: #3b82f6;
      color: white;
    }

    .badge-charts {
      background: #10b981;
      color: white;
    }

    .badge-social {
      background: #8b5cf6;
      color: white;
    }

    /* Connecting lines */
    .connect-line {
      position: absolute;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, rgba(59, 130, 246, 0.3), #3b82f6);
      z-index: 999;
      pointer-events: none;
      animation: lineFlow 3s ease-in-out infinite;
    }

    @keyframes lineFlow {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* iPad-style toggle switch */
    .view-toggle {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #d1d5db;
      border-radius: 25px;
      padding: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      width: 160px;
      height: 40px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }

    .toggle-track {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      border-radius: 20px;
    }

    .toggle-option {
      flex: 1;
      text-align: center;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 18px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .toggle-option.active {
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .toggle-option.inactive {
      color: #6b7280;
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: calc(50% - 2px);
      height: calc(100% - 4px);
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      border-radius: 18px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
      z-index: 1;
    }

    .view-toggle.image-mode .toggle-slider {
      transform: translateX(100%);
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
    }

    /* Pin mode button */
    .pin-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .pin-toggle.active { background: #10b981; }

    .clear-btn {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 1000;
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Image view */
    .image-view {
      width: 100vw;
      height: 100vh;
      position: relative;
      background: #f3f4f6;
      display: none;
      overflow: hidden;
    }

    .image-view.active {
      display: block;
    }

    .background-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: crosshair;
    }

    .image-selector {
      position: absolute;
      top: 70px;
      left: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .image-option {
      display: block;
      width: 80px;
      height: 60px;
      margin: 4px 0;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      object-fit: cover;
      transition: all 0.2s;
    }

    .image-option:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }

    .image-option.selected {
      border-color: #10b981;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="image-view" id="imageView">
    <img class="background-image" id="backgroundImage" src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&h=1080&fit=crop" alt="Background">
    <div class="image-selector">
      <img class="image-option selected" src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=160&h=120&fit=crop" onclick="changeBackgroundImage('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&h=1080&fit=crop')" alt="Ocean">
      <img class="image-option" src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=160&h=120&fit=crop" onclick="changeBackgroundImage('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1920&h=1080&fit=crop')" alt="Forest">
      <img class="image-option" src="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=160&h=120&fit=crop" onclick="changeBackgroundImage('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=1920&h=1080&fit=crop')" alt="City">
      <img class="image-option" src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=160&h=120&fit=crop" onclick="changeBackgroundImage('https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=1920&h=1080&fit=crop')" alt="Mountains">
    </div>
  </div>

  <div class="view-toggle" id="viewToggle" onclick="toggleView()">
    <div class="toggle-track">
      <div class="toggle-slider"></div>
      <div class="toggle-option active" id="mapOption">
        <span>🗺️</span>
        <span>Map</span>
      </div>
      <div class="toggle-option inactive" id="imageOption">
        <span>🇺️</span>
        <span>Image</span>
      </div>
    </div>
  </div>

  <button class="pin-toggle" id="toggleBtn" onclick="togglePinMode()">📍 Click to Add Pins</button>
  <button class="clear-btn" onclick="clearCustomPins()">🔄 Reset</button>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    let isPinMode = false;
    let pinData = [];
    let isImageView = false;

    // Setup template switcher functionality
    function setupTemplateButton(callout, pinInfo) {
      const templateBtn = callout.querySelector('.template-btn');

      const templates = [
        {
          name: 'quotes',
          class: 'template-quotes',
          badge: 'badge-quotes',
          icon: '💬',
          title: '"This product changed everything for our business"',
          content: `<div class="quote-author">— Sarah Johnson</div>
                   <div class="quote-role">CEO, TechStart Inc.</div>
                   <div class="quote-location">📍 Manchester</div>`
        },
        {
          name: 'statistics',
          class: 'template-statistics',
          badge: 'badge-statistics',
          icon: '📊',
          title: '85%',
          content: `<div class="stat-description">of customers report <strong>increased productivity</strong> within first month of implementation</div>
                   <div class="stat-source">Survey of 2,500+ users • March 2024</div>`
        },
        {
          name: 'charts',
          class: 'template-charts',
          badge: 'badge-charts',
          icon: '📈',
          title: 'Performance Growth',
          content: `<div class="chart-placeholder">
                     <div class="chart-type-toggle">
                       <button class="chart-btn active" data-chart="bar">Bar Chart</button>
                       <button class="chart-btn" data-chart="pie">Pie Chart</button>
                     </div>
                     <div class="chart-display">
                       <div class="mini-bar-chart">
                         <div class="bar" style="height: 40%; background: #10b981;"><div class="bar-value">10</div></div>
                         <div class="bar" style="height: 60%; background: #3b82f6;"><div class="bar-value">15</div></div>
                         <div class="bar" style="height: 100%; background: #f59e0b;"><div class="bar-value">25</div></div>
                       </div>
                       <div class="mini-pie-chart"></div>
                     </div>
                     <div class="chart-values">
                       <input type="number" class="chart-value" value="10" min="0" max="999">
                       <input type="number" class="chart-value" value="15" min="0" max="999">
                       <input type="number" class="chart-value" value="25" min="0" max="999">
                     </div>
                   </div>
                   <div class="chart-source">
                     <input type="text" class="chart-source-input" value="Survey of 2,500+ users • March 2024" placeholder="Add source or description..." maxlength="150">
                   </div>
                 `
        },
        {
          name: 'social',
          class: 'template-social',
          badge: 'badge-social',
          icon: '📱',
          title: '@techinfluencer',
          content: `<div class="social-platform">LinkedIn</div>
                   <div class="social-text">"Just tried this amazing tool - game changer for productivity! 🚀 #TechReview"</div>
                   <div class="social-engagement">❤️ 234 • 🔄 45 • 💬 12</div>`
        }
      ];

      let currentTemplateIndex = 0;

      templateBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();

        // Cycle to next template
        currentTemplateIndex = (currentTemplateIndex + 1) % templates.length;
        const newTemplate = templates[currentTemplateIndex];

        console.log('🎨 Switching to template:', newTemplate.name);

        // Remove old template classes
        templates.forEach(t => callout.classList.remove(t.class));

        // Add new template class
        callout.classList.add(newTemplate.class);
        callout.setAttribute('data-template', newTemplate.name);

        // Update content
        const title = callout.querySelector('.editable-title');
        const body = callout.querySelector('.editable-body');
        const hint = callout.querySelector('.edit-hint');

        if (title) title.textContent = newTemplate.title;
        if (body) body.innerHTML = newTemplate.content;

        // Setup chart functionality if this is a charts template
        if (newTemplate.name === 'charts') {
          // Remove contenteditable from body for charts
          if (body) body.removeAttribute('contenteditable');
          setupChartInteractions(callout);
        } else {
          // Re-add contenteditable for non-chart templates
          if (body) body.setAttribute('contenteditable', 'true');
        }

        // Update hint based on template
        if (hint) {
          switch(newTemplate.name) {
            case 'quotes':
              hint.textContent = '💬 Customer Quote • Edit name & testimonial';
              break;
            case 'statistics':
              hint.textContent = '📊 Survey Stats • Edit percentage & description';
              break;
            case 'charts':
              hint.textContent = '📈 Data Chart • Hover to edit values';
              break;
            case 'social':
              hint.textContent = '📱 Social Media • Edit platform & post';
              break;
            default:
              hint.textContent = '💡 Click to edit • Drag to move';
          }
        }

        // Add template switch animation
        callout.style.transform = 'scale(0.95) rotate(5deg)';
        setTimeout(() => {
          callout.style.transform = '';
        }, 200);

        console.log('✅ Template switched successfully');
      });

      // Prevent template button from triggering drag
      templateBtn.addEventListener('mousedown', (e) => {
        e.stopPropagation();
      });
    }

    // Setup safe max length for non-chart templates
    function setupSafeMaxLength(callout) {
      const isChartTemplate = callout.classList.contains('template-charts');
      const editableTitle = callout.querySelector('.editable-title');
      const editableBody = callout.querySelector('.editable-body');

      // Title max length: 100 characters (safe for all templates)
      if (editableTitle) {
        editableTitle.addEventListener('input', function() {
          const text = this.innerText || '';
          if (text.length > 100) {
            // Prevent further input instead of truncating
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);

            // Restore to 100 characters
            this.innerText = text.substring(0, 100);

            // Restore cursor to end
            const newRange = document.createRange();
            newRange.selectNodeContents(this);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        });
      }

      // Body max length: Only for non-chart templates (charts need HTML structure)
      if (editableBody && !isChartTemplate) {
        editableBody.addEventListener('input', function() {
          const text = this.innerText || '';
          if (text.length > 400) {
            // Prevent further input for text-only templates
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);

            // Restore to 400 characters
            this.innerText = text.substring(0, 400);

            // Restore cursor to end
            const newRange = document.createRange();
            newRange.selectNodeContents(this);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        });
      }

      console.log(`📏 Safe max length set for ${callout.getAttribute('data-template')} template: Title(100)${!isChartTemplate ? ', Body(400)' : ''}`);
    }

    // Setup chart interactions
    function setupChartInteractions(callout) {
      const chartBtns = callout.querySelectorAll('.chart-btn');
      const barChart = callout.querySelector('.mini-bar-chart');
      const pieChart = callout.querySelector('.mini-pie-chart');
      const chartValues = callout.querySelectorAll('.chart-value');

      console.log('🔧 Setting up chart interactions, found', chartValues.length, 'value elements');

      // Chart type toggle
      chartBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          chartBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const chartType = btn.getAttribute('data-chart');
          console.log('📊 Switching chart type to:', chartType);

          if (chartType === 'bar') {
            barChart.style.display = 'flex';
            pieChart.style.display = 'none';
            updateBarChart(callout);
          } else {
            barChart.style.display = 'none';
            pieChart.style.display = 'block';
            updatePieChart(callout);
          }
        });
      });

      // Value change updates with input elements
      chartValues.forEach((valueEl, index) => {
        // Use input and change events for input elements
        const updateCharts = () => {
          const newValue = parseInt(valueEl.value) || 0;
          console.log(`📈 Value ${index + 1} changed to:`, newValue);

          updateBarChart(callout);

          // Update pie chart if visible
          if (pieChart && (pieChart.style.display === 'block' || pieChart.style.display === '')) {
            updatePieChart(callout);
          }
        };

        valueEl.addEventListener('input', updateCharts);
        valueEl.addEventListener('change', updateCharts);

        valueEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            valueEl.blur();
          }
        });
      });

      // Initialize charts with proper visibility
      setTimeout(() => {
        // Ensure bar chart is visible by default
        if (barChart) {
          barChart.style.display = 'flex';
        }
        if (pieChart) {
          pieChart.style.display = 'none';
        }

        updateBarChart(callout);
        console.log('📊 Charts initialized - Bar visible, Pie hidden');
      }, 100);
    }

    function updateBarChart(callout) {
      const chartValues = callout.querySelectorAll('.chart-value');
      const barChart = callout.querySelector('.mini-bar-chart');

      if (!barChart || chartValues.length === 0) {
        console.log('❌ Bar chart elements not found');
        return;
      }

      const values = Array.from(chartValues).map(v => parseInt(v.value) || 0);
      const maxVal = Math.max(...values, 1); // Ensure at least 1 to avoid division by zero
      const colors = ['#10b981', '#3b82f6', '#f59e0b']; // Same colors as pie chart

      console.log('📊 Updating bar chart with values:', values, 'max:', maxVal);

      // Update each bar
      values.forEach((value, index) => {
        const bar = barChart.children[index];
        if (bar) {
          const height = (value / maxVal) * 100;
          bar.style.height = `${Math.max(height, 8)}%`;

          // Set different color for each bar
          bar.style.background = colors[index] || colors[0];

          // Add or update value label
          let valueLabel = bar.querySelector('.bar-value');
          if (!valueLabel) {
            valueLabel = document.createElement('div');
            valueLabel.className = 'bar-value';
            bar.appendChild(valueLabel);
          }
          valueLabel.textContent = value;

          console.log(`📈 Bar ${index + 1}: height=${height}%, value=${value}, color=${colors[index]}`);
        }
      });
    }

    function updatePieChart(callout) {
      const chartValues = callout.querySelectorAll('.chart-value');
      const pieChart = callout.querySelector('.mini-pie-chart');

      const values = Array.from(chartValues).map(v => parseInt(v.value) || 0);
      const total = values.reduce((sum, val) => sum + val, 0);

      console.log('🥧 Updating pie chart with values:', values, 'total:', total);

      // Clear existing value labels
      pieChart.querySelectorAll('.pie-value').forEach(label => label.remove());

      if (total === 0) {
        pieChart.style.background = '#e5e7eb';
        return;
      }

      const colors = ['#10b981', '#3b82f6', '#f59e0b'];
      let currentAngle = 0;
      let gradientParts = [];

      values.forEach((value, index) => {
        if (value > 0) {
          const percentage = (value / total) * 360;
          const endAngle = currentAngle + percentage;

          gradientParts.push(`${colors[index]} ${currentAngle}deg ${endAngle}deg`);

          // Add value label at the center of each slice
          if (percentage > 20) { // Only show label if slice is large enough
            const middleAngle = (currentAngle + endAngle) / 2;
            const labelAngle = (middleAngle - 90) * (Math.PI / 180); // Convert to radians, adjust for 12 o'clock start

            const radius = 30; // Distance from center
            const x = Math.cos(labelAngle) * radius + 50; // 50 is center of 100px circle
            const y = Math.sin(labelAngle) * radius + 50;

            const valueLabel = document.createElement('div');
            valueLabel.className = 'pie-value';
            valueLabel.textContent = value;
            valueLabel.style.left = `${x - 8}px`; // Center the text
            valueLabel.style.top = `${y - 6}px`;
            pieChart.appendChild(valueLabel);
          }

          currentAngle = endAngle;

          console.log(`🍰 Slice ${index + 1}: ${value} (${Math.round(percentage)}°)`);
        }
      });

      pieChart.style.background = `conic-gradient(${gradientParts.join(', ')})`;
    }

    // Initialize map
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            "tileSize": 256
          }
        },
        "layers": [{"id": "osm", "type": "raster", "source": "osm"}]
      },
      center: [-1.5, 54],
      zoom: 6
    });

    map.addControl(new maplibregl.NavigationControl());

    const feedbacks = [
      "Great product! Really loving the features 😍",
      "Excellent customer service, highly recommend! ⭐⭐⭐⭐⭐",
      "Good value for money. Works as expected ✅",
      "Amazing quality! Will definitely buy again 🚀",
      "Fast delivery and great packaging 📦",
      "User-friendly interface, easy to use 👍",
      "Outstanding performance! 5 stars ⭐⭐⭐⭐⭐"
    ];

    // Create pin with floating callout
    function createPin(coords, feedbackText, title = "💬 Customer Feedback", rating = 4, isDemo = false) {
      // Create marker
      const marker = new maplibregl.Marker({ color: 'red' })
        .setLngLat(coords)
        .addTo(map);

      // Create floating callout with editable content
      const callout = document.createElement('div');
      callout.className = 'floating-callout template-quotes';
      callout.setAttribute('data-template', 'quotes');
      callout.innerHTML = `
        <div class="delete-btn" title="Delete this callout">×</div>
        <div class="template-btn" title="Change template">⚡</div>
        <div class="editable-title" contenteditable="true">${title}</div>
        <div class="thumbs-selector">
          <span class="thumb ${1 <= rating ? 'active' : ''}" data-rating="1">★</span>
          <span class="thumb ${2 <= rating ? 'active' : ''}" data-rating="2">★</span>
          <span class="thumb ${3 <= rating ? 'active' : ''}" data-rating="3">★</span>
          <span class="thumb ${4 <= rating ? 'active' : ''}" data-rating="4">★</span>
          <span class="thumb ${5 <= rating ? 'active' : ''}" data-rating="5">★</span>
        </div>
        <div class="editable-body" contenteditable="true">${feedbackText}</div>
        <div class="edit-hint">💡 Click to edit • Drag to move</div>
      `;

      // Create connecting line
      const line = document.createElement('div');
      line.className = 'connect-line';

      // Add to DOM
      document.body.appendChild(callout);
      document.body.appendChild(line);

      // Create pinInfo object first
      const pinInfo = {
        marker,
        callout,
        line,
        coords: [...coords],
        isDemo,
        manuallyPositioned: false,
        rating: rating
      };

      // Now setup functionality with pinInfo available
      setupThumbsRating(callout);
      setupDeleteButton(callout, pinInfo);
      setupTemplateButton(callout, pinInfo);
      setupSafeMaxLength(callout);

      // Setup chart interactions if this is a chart template
      if (callout.classList.contains('template-charts')) {
        setupChartInteractions(callout);
      }

      // Position callout near pin
      positionCallout(marker, callout);

      // Trigger Lottie-like popup animation
      setTimeout(() => {
        callout.classList.add('show');
        setTimeout(() => {
          callout.classList.add('active');
        }, 800);
      }, 100);

      // Add to pinData array
      pinData.push(pinInfo);

      // Draw connecting line
      drawLine(pinInfo);

      // Make callout draggable
      makeDraggable(callout, pinInfo);

      return pinInfo;
    }

    // Position callout near pin
    function positionCallout(marker, callout) {
      const markerEl = marker.getElement();
      const markerRect = markerEl.getBoundingClientRect();

      // Position callout to the right of pin with some offset
      let left = markerRect.left + 50;
      let top = markerRect.top - 60;

      // Keep within screen bounds
      if (left + 300 > window.innerWidth) left = markerRect.left - 320;
      if (top < 20) top = 20;
      if (top + 150 > window.innerHeight) top = window.innerHeight - 170;

      callout.style.left = left + 'px';
      callout.style.top = top + 'px';
    }

    // Draw line between pin and callout
    function drawLine(pinInfo) {
      const { marker, callout, line } = pinInfo;
      const markerEl = marker.getElement();

      const markerRect = markerEl.getBoundingClientRect();
      const calloutRect = callout.getBoundingClientRect();

      const x1 = markerRect.left + markerRect.width / 2;
      const y1 = markerRect.top + markerRect.height / 2;
      const x2 = calloutRect.left;
      const y2 = calloutRect.top + calloutRect.height / 2;

      const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
      const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;

      line.style.left = x1 + 'px';
      line.style.top = y1 + 'px';
      line.style.width = length + 'px';
      line.style.transform = `rotate(${angle}deg)`;
      line.style.transformOrigin = '0 50%';
    }

    // Setup rating functionality (now with stars)
    function setupThumbsRating(callout) {
      const thumbs = callout.querySelectorAll('.thumb');
      console.log('Setting up stars:', thumbs.length);

      thumbs.forEach((thumb, index) => {
        thumb.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();

          const clickedRating = parseInt(thumb.getAttribute('data-rating'));
          console.log('★ Star clicked, rating:', clickedRating);

          // Update all stars in this callout
          thumbs.forEach((t) => {
            const thumbRating = parseInt(t.getAttribute('data-rating'));

            if (thumbRating <= clickedRating) {
              // Active stars - golden and glowing
              t.classList.add('active');
              t.style.color = '#fbbf24';
              t.style.textShadow = '0 0 8px rgba(251, 191, 36, 0.6)';
              console.log(`★ Star ${thumbRating} set to ACTIVE (golden)`);
            } else {
              // Inactive stars - stay gray
              t.classList.remove('active');
              t.style.color = '#d1d5db';
              t.style.textShadow = '1px 1px 1px rgba(0,0,0,0.1)';
              console.log(`☆ Star ${thumbRating} set to INACTIVE (gray)`);
            }
          });

          console.log('✅ All stars updated!');
        });

        thumb.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.preventDefault();
        });
      });
    }

    // Setup delete button functionality
    function setupDeleteButton(callout, pinInfo) {
      const deleteBtn = callout.querySelector('.delete-btn');

      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();

        console.log('🗑️ Deleting callout');

        // Add delete animation
        callout.style.animation = 'none';
        callout.style.transform = 'scale(0.8) rotate(10deg)';
        callout.style.opacity = '0';

        // Remove from pinData array
        const index = pinData.indexOf(pinInfo);
        if (index > -1) {
          pinData.splice(index, 1);
        }

        // Remove elements after animation
        setTimeout(() => {
          if (pinInfo.marker) pinInfo.marker.remove(); // Map marker
          if (pinInfo.pinMarker) pinInfo.pinMarker.remove(); // Image pin marker
          callout.remove();
          pinInfo.line.remove();
          console.log('✅ Callout deleted successfully');
        }, 300);
      });

      // Prevent delete button from triggering drag
      deleteBtn.addEventListener('mousedown', (e) => {
        e.stopPropagation();
      });
    }

    function makeDraggable(callout, pinInfo) {
      let isDragging = false;
      let startX, startY;
      let dragStarted = false;

      callout.addEventListener('mousedown', (e) => {
        // Don't start drag if clicking on editable elements or thumbs
        if (e.target.contentEditable === 'true' ||
            e.target.classList.contains('thumb') ||
            e.target.closest('.thumbs-selector') ||
            e.target.closest('.editable-title') ||
            e.target.closest('.editable-body')) {
          console.log('Clicked on editable element, not dragging');
          return;
        }

        console.log('Starting drag mode');
        isDragging = true;
        dragStarted = false;
        startX = e.clientX - callout.offsetLeft;
        startY = e.clientY - callout.offsetTop;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        if (!dragStarted) {
          const moveDistance = Math.abs(e.clientX - (startX + callout.offsetLeft)) +
                               Math.abs(e.clientY - (startY + callout.offsetTop));
          if (moveDistance > 5) {
            dragStarted = true;
            callout.style.animationPlayState = 'paused';
            console.log('Drag started');
          } else {
            return;
          }
        }

        const newX = e.clientX - startX;
        const newY = e.clientY - startY;

        const maxX = window.innerWidth - callout.offsetWidth;
        const maxY = window.innerHeight - callout.offsetHeight;

        callout.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
        callout.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';

        pinInfo.manuallyPositioned = true;
        drawLine(pinInfo);
      });

      document.addEventListener('mouseup', () => {
        if (isDragging && dragStarted) {
          callout.style.animationPlayState = 'running';
          console.log('Drag ended');
        }
        isDragging = false;
        dragStarted = false;
      });
    }

    // Update all lines when map moves
    function updateAllLines() {
      pinData.forEach(pinInfo => {
        // Only reposition callouts that haven't been manually moved
        if (!pinInfo.manuallyPositioned) {
          positionCallout(pinInfo.marker, pinInfo.callout);
        }
        drawLine(pinInfo);
      });
    }

    // Handle map click
    map.on('click', (e) => {
      if (!isPinMode) return;

      const coords = e.lngLat;
      const randomFeedback = feedbacks[Math.floor(Math.random() * feedbacks.length)];
      const randomRating = Math.floor(Math.random() * 2) + 4; // 4-5 stars

      createPin([coords.lng, coords.lat], randomFeedback, "💬 Customer Feedback", randomRating);
    });

    // Map event handlers
    map.on('move', updateAllLines);
    map.on('zoom', updateAllLines);

    // Toggle pin mode
    function togglePinMode() {
      isPinMode = !isPinMode;
      const btn = document.getElementById('toggleBtn');

      if (isPinMode) {
        btn.textContent = '📍 Pin Mode ON - Click Map';
        btn.classList.add('active');
      } else {
        btn.textContent = '📍 Click to Add Pins';
        btn.classList.remove('active');
      }
    }

    // Reset (clear) custom pins
    function clearCustomPins() {
      pinData = pinData.filter(pinInfo => {
        if (!pinInfo.isDemo) {
          // Remove map marker if it exists
          if (pinInfo.marker) {
            pinInfo.marker.remove();
          }
          // Remove image pin marker if it exists
          if (pinInfo.pinMarker) {
            pinInfo.pinMarker.remove();
          }
          // Remove callout and line
          pinInfo.callout.remove();
          pinInfo.line.remove();

          console.log('🔄 Removed custom pin');
          return false; // Remove from array
        }
        return true; // Keep demo pins
      });

      console.log('✅ Reset complete - all custom pins removed');
    }

    // Toggle between map and image view
    function toggleView() {
      const mapView = document.getElementById('map');
      const imageView = document.getElementById('imageView');
      const viewToggle = document.getElementById('viewToggle');
      const mapOption = document.getElementById('mapOption');
      const imageOption = document.getElementById('imageOption');

      isImageView = !isImageView;

      if (isImageView) {
        // Switch to image view
        mapView.style.display = 'none';
        imageView.classList.add('active');

        // Update toggle appearance
        viewToggle.classList.add('image-mode');
        mapOption.classList.remove('active');
        mapOption.classList.add('inactive');
        imageOption.classList.remove('inactive');
        imageOption.classList.add('active');

        // Hide map callouts and show image callouts
        hideMapCallouts();
        showImageCallouts();

        console.log('🖼️ Switched to Image View');
      } else {
        // Switch to map view
        mapView.style.display = 'block';
        imageView.classList.remove('active');

        // Update toggle appearance
        viewToggle.classList.remove('image-mode');
        imageOption.classList.remove('active');
        imageOption.classList.add('inactive');
        mapOption.classList.remove('inactive');
        mapOption.classList.add('active');

        // Hide image callouts and show map callouts
        hideImageCallouts();
        showMapCallouts();

        console.log('🗺️ Switched to Map View');
      }
    }

    // Hide map callouts (those with map markers)
    function hideMapCallouts() {
      pinData.forEach(pinInfo => {
        if (pinInfo.marker) { // Map callouts have markers
          pinInfo.callout.style.display = 'none';
          pinInfo.line.style.display = 'none';
        }
      });
    }

    // Show map callouts
    function showMapCallouts() {
      pinData.forEach(pinInfo => {
        if (pinInfo.marker) { // Map callouts have markers
          pinInfo.callout.style.display = 'block';
          pinInfo.line.style.display = 'block';
          // Update their positions
          if (!pinInfo.manuallyPositioned) {
            positionCallout(pinInfo.marker, pinInfo.callout);
          }
          drawLine(pinInfo);
        }
      });
    }

    // Hide image callouts (those with pin markers)
    function hideImageCallouts() {
      pinData.forEach(pinInfo => {
        if (pinInfo.pinMarker) { // Image callouts have pinMarkers
          pinInfo.callout.style.display = 'none';
          pinInfo.line.style.display = 'none';
          pinInfo.pinMarker.style.display = 'none';
        }
      });
    }

    // Show image callouts
    function showImageCallouts() {
      pinData.forEach(pinInfo => {
        if (pinInfo.pinMarker) { // Image callouts have pinMarkers
          pinInfo.callout.style.display = 'block';
          pinInfo.line.style.display = 'block';
          pinInfo.pinMarker.style.display = 'block';
          // Update their positions
          drawImageLine(pinInfo);
        }
      });
    }

    // Change background image
    function changeBackgroundImage(imageUrl) {
      const backgroundImage = document.getElementById('backgroundImage');
      const imageOptions = document.querySelectorAll('.image-option');

      backgroundImage.src = imageUrl;

      // Update selected state
      imageOptions.forEach(option => {
        if (option.onclick.toString().includes(imageUrl)) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });

      console.log('🖼️ Background image changed to:', imageUrl);
    }

    // Handle image clicks for pin placement
    function setupImageClickHandler() {
      const backgroundImage = document.getElementById('backgroundImage');

      backgroundImage.addEventListener('click', (e) => {
        if (!isPinMode || !isImageView) return;

        const rect = backgroundImage.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Convert to percentage coordinates (for responsive positioning)
        const xPercent = (x / rect.width) * 100;
        const yPercent = (y / rect.height) * 100;

        const randomFeedback = feedbacks[Math.floor(Math.random() * feedbacks.length)];
        const randomRating = Math.floor(Math.random() * 2) + 4; // 4-5 stars

        createImagePin([xPercent, yPercent], randomFeedback, "💬 Customer Feedback", randomRating);
      });
    }

    // Create pin for image view
    function createImagePin(coords, feedbackText, title = "💬 Customer Feedback", rating = 4, isDemo = false) {
      // Create callout (no marker needed for image view)
      const callout = document.createElement('div');
      callout.className = 'floating-callout template-quotes';
      callout.setAttribute('data-template', 'quotes');
      callout.innerHTML = `
        <div class="delete-btn" title="Delete this callout">×</div>
        <div class="template-btn" title="Change template">⚡</div>
        <div class="editable-title" contenteditable="true">${title}</div>
        <div class="thumbs-selector">
          <span class="thumb ${1 <= rating ? 'active' : ''}" data-rating="1">★</span>
          <span class="thumb ${2 <= rating ? 'active' : ''}" data-rating="2">★</span>
          <span class="thumb ${3 <= rating ? 'active' : ''}" data-rating="3">★</span>
          <span class="thumb ${4 <= rating ? 'active' : ''}" data-rating="4">★</span>
          <span class="thumb ${5 <= rating ? 'active' : ''}" data-rating="5">★</span>
        </div>
        <div class="editable-body" contenteditable="true">${feedbackText}</div>
        <div class="edit-hint">💡 Click to edit • Drag to move</div>
      `;

      // Create connecting line
      const line = document.createElement('div');
      line.className = 'connect-line';

      // Add to DOM
      document.body.appendChild(callout);
      document.body.appendChild(line);

      // Position callout based on percentage coordinates
      const imageView = document.getElementById('imageView');
      const rect = imageView.getBoundingClientRect();

      const x = (coords[0] / 100) * rect.width;
      const y = (coords[1] / 100) * rect.height;

      callout.style.left = Math.min(x + 50, window.innerWidth - 320) + 'px';
      callout.style.top = Math.max(y - 60, 20) + 'px';

      // Create pin marker for image (visual pin point)
      const pinMarker = document.createElement('div');
      pinMarker.className = 'image-pin-marker';
      pinMarker.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        width: 12px;
        height: 12px;
        background: #ef4444;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 999;
        pointer-events: none;
      `;
      imageView.appendChild(pinMarker);

      // Create pinInfo object
      const pinInfo = {
        marker: null, // No map marker for image pins
        callout,
        line,
        pinMarker,
        coords: [...coords],
        isDemo,
        manuallyPositioned: false,
        rating: rating
      };

      // Setup functionality
      setupThumbsRating(callout);
      setupDeleteButton(callout, pinInfo);
      setupTemplateButton(callout, pinInfo);
      setupSafeMaxLength(callout);

      // Setup chart interactions if this is a chart template
      if (callout.classList.contains('template-charts')) {
        setupChartInteractions(callout);
      }

      // Trigger popup animation
      setTimeout(() => {
        callout.classList.add('show');
        setTimeout(() => {
          callout.classList.add('active');
        }, 800);
      }, 100);

      // Add to pinData array
      pinData.push(pinInfo);

      // Draw connecting line
      drawImageLine(pinInfo);

      // Make callout draggable
      makeImageDraggable(callout, pinInfo);

      return pinInfo;
    }

    // Draw line for image pins
    function drawImageLine(pinInfo) {
      const { callout, line, pinMarker } = pinInfo;

      const pinRect = pinMarker.getBoundingClientRect();
      const calloutRect = callout.getBoundingClientRect();

      const x1 = pinRect.left + pinRect.width / 2;
      const y1 = pinRect.top + pinRect.height / 2;
      const x2 = calloutRect.left;
      const y2 = calloutRect.top + calloutRect.height / 2;

      const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
      const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;

      line.style.left = x1 + 'px';
      line.style.top = y1 + 'px';
      line.style.width = length + 'px';
      line.style.transform = `rotate(${angle}deg)`;
      line.style.transformOrigin = '0 50%';
    }

    // Make callout draggable in image view
    function makeImageDraggable(callout, pinInfo) {
      let isDragging = false;
      let startX, startY;
      let dragStarted = false;

      callout.addEventListener('mousedown', (e) => {
        if (e.target.contentEditable === 'true' ||
            e.target.classList.contains('thumb') ||
            e.target.closest('.thumbs-selector') ||
            e.target.closest('.editable-title') ||
            e.target.closest('.editable-body')) {
          return;
        }

        isDragging = true;
        dragStarted = false;
        startX = e.clientX - callout.offsetLeft;
        startY = e.clientY - callout.offsetTop;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        if (!dragStarted) {
          const moveDistance = Math.abs(e.clientX - (startX + callout.offsetLeft)) +
                               Math.abs(e.clientY - (startY + callout.offsetTop));
          if (moveDistance > 5) {
            dragStarted = true;
            callout.style.animationPlayState = 'paused';
          } else {
            return;
          }
        }

        const newX = e.clientX - startX;
        const newY = e.clientY - startY;

        const maxX = window.innerWidth - callout.offsetWidth;
        const maxY = window.innerHeight - callout.offsetHeight;

        callout.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
        callout.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';

        pinInfo.manuallyPositioned = true;
        drawImageLine(pinInfo);
      });

      document.addEventListener('mouseup', () => {
        if (isDragging && dragStarted) {
          callout.style.animationPlayState = 'running';
        }
        isDragging = false;
        dragStarted = false;
      });
    }

    // Add demo pins on load
    map.on('load', () => {
      setTimeout(() => {
        createPin([-0.1276, 51.5074], "Amazing fintech integration! Perfect for our London office. The API response times are incredible.", "🏙️ London Tech Hub", 5, true);
        createPin([-2.2426, 53.4808], "Solid industrial-grade quality. Built to last like our Manchester mills!", "⚒️ Manchester Industry", 4, true);
        createPin([-3.1883, 55.9533], "Exceptional Highland quality! Weather tested in tough Scottish conditions.", "🏴󠁧󠁢󠁳󠁣󠁴󠁿 Edinburgh Innovation", 5, true);
      }, 500);
    });

    // Initialize image view
    setupImageClickHandler();
  </script>
</body>
</html>